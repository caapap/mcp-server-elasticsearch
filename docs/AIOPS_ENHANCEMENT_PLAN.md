# AIOps 增强规划：索引模板与数据活性管理

本方案旨在增强 `mcp-server-elasticsearch` 在企业级运维场景下的感知与操作能力，通过原子化的 MCP 工具与 AI 智能决策相结合，实现主动治理与安全演进。

## 场景一：模板深度探测 (Template Discovery)

### 1.1 模板综合查询 (get_templates)
- **目标**：一站式解决模板的查看、搜索和反查匹配问题。
- **功能参数**：
    - `name` (可选): 按模板名称过滤（支持 `*` 通配符）。
    - `matching_index` (可选): 输入索引名（如 `fdz-202512`），返回其应用的模板。
- **技术实现**：
    - 若指定 `matching_index`，MCP 会拉取全量模板并在 Rust 侧执行匹配逻辑（模拟 ES 的 `index_patterns` 匹配与 `order` 优先级排序），返回最终胜出的模板定义。
    - 若不指定参数，默认返回全量模板摘要。

## 场景二：模板安全演进 (Safe Evolution)

### 2.1 交互流程：先预检，后执行
这是一个两阶段的交互过程，确保配置变更的安全可控。

1. **阶段一：预检分析 (Pre-flight Check)**
   - AI 调用 `get_template` 获取旧版本。
   - AI 对比新旧配置，生成**风险报告**：
     - ⚠️ **字段冲突**：如 `swTimesA` 从动态类型改为 `keyword`（可能导致写入拒绝）。
     - ⚠️ **性能风险**：分片数从 5 激增至 50（节点内存压力）。
     - ⚠️ **配置降级**：副本数被设置为 0（数据丢失风险）。
2. **阶段二：执行变更**
   - 只有在用户确认风险报告后，才调用 `upsert_template` 执行物理变更。

### 2.2 风险阻断 (Risk Block)
在 MCP 工具层（Rust 代码）实现硬性安全约束：
- **分片限制**：单索引主分片数不得超过阈值（如 50）。
- **副本强制**：生产环境副本数至少为 1（除非通过 `force` 参数覆盖）。
- **防爆保护**：`max_result_window` 不得超过 1000万。

## 场景三：数据接入活性监控 (Data Vitality Check)

### 3.1 智能接入画像
- **目标**：监控业务数据流是否中断，服务接入是否正常。
- **工具设计**：`check_ingestion_vitality(index_pattern)`
- **核心逻辑**：
    1. **智能探测**：自动分析 Mapping，识别时间戳字段（查找 `date` 类型或匹配 `timestamp/time` 命名）。
    2. **极简查询**：执行 `size: 1, _source: [timestamp_field], sort: desc`，最小化开销。
    3. **时延计算**：计算 `Now - Last_Record_Time`。
- **诊断输出**：
    - 🟢 **健康**：延迟 < 5分钟。
    - 🟡 **滞后**：延迟 5-30分钟（可能存在积压）。
    - 🔴 **断流**：延迟 > 30分钟（采集链路故障或服务停摆）。

## 技术实现路线 (Rust Implementation)

### 阶段 1：基础读取能力 (Read-Only)
- [x] 实现 `get_templates`：封装 `GET /_template` 并解析摘要，支持通配符过滤和索引匹配查询。
  - ✅ 支持按模板名称过滤（支持 `*` 通配符）
  - ✅ 支持反查：输入索引名返回匹配的模板
  - ✅ 实现模板匹配算法（`index_patterns` 匹配与 `order` 优先级排序）
- [ ] 实现 `check_vitality`：封装智能时间戳查询逻辑。

### 阶段 2：高级管理能力 (Write & Logic)
- [ ] 实现 `upsert_template`：封装 `PUT /_template`，并集成安全检查参数。
- [ ] 实现风险检查逻辑：字段冲突、性能风险、配置降级检测。
- [ ] 实现硬性安全约束：分片限制、副本强制、防爆保护。
